#!/bin/bash

show_help() {
    cat << EOF
Usage: $0 [options] <domain-name> [<domain-name> ...]

Query WHOIS information for domain names with caching support.

Options:
    -f, --force-refresh   Force a new lookup bypassing cached data
    -r, --registrar       Query registrar's whois server (.com and .net)
    -s, --summary         Show only registration and expiry dates (brief output)
    -h, --help            Display this help message and exit

Examples:
    $0 example.com                    # Show full WHOIS data
    $0 -s example.com example.org     # Show summary for multiple domains
    $0 -frs example.com               # Combine flags: force refresh, registrar, summary

Default behavior:
    - Uses cached data when available
    - Shows full WHOIS output (use -s for summary)
    - Queries registry server only (use -r for registrar)

Supported TLDs:
    .com, .net, .org, .biz, .us, .uk, .gov, .edu, .kr, .mobi
    .ac.uk, .gov.uk, .co.kr, .or.kr, .ne.kr, .pe.kr, .go.kr, .re.kr, etc. (multi-level TLDs)
EOF
    exit 0
}

if [[ $# -lt 1 ]]; then
    show_help
fi

# Convert long options to short options
args=()
for arg in "$@"; do
    case "$arg" in
        --force-refresh) args+=("-f") ;;
        --registrar)     args+=("-r") ;;
        --summary)       args+=("-s") ;;
        --help)          args+=("-h") ;;
        *)               args+=("$arg") ;;
    esac
done
set -- "${args[@]}"

# Parse options using getopts
force_refresh=0
registrar=0
summary=0

while getopts "frsh" opt; do
    case $opt in
        f)
            force_refresh=1
            ;;
        r)
            registrar=1
            ;;
        s)
            summary=1
            ;;
        h)
            show_help
            ;;
        \?)
            echo "Invalid option: -$OPTARG" >&2
            show_help
            ;;
    esac
done

# Shift past the options to get domain names
shift $((OPTIND - 1))

# Collect domain names
domains=("$@")

dir=$(dirname "$0")
cache_dir="$dir/whois-cache"

if [[ ! -d "$cache_dir" ]]; then
    mkdir -p "$cache_dir"
fi

# Configuration: WHOIS servers by TLD
declare -A WHOIS_SERVERS=(
    [com]="whois.verisign-grs.com"
    [net]="whois.verisign-grs.com"
    [org]="whois.pir.org"
    [biz]="whois.biz"
    [mobi]="whois.dotmobiregistry.net"
    [edu]="whois.educause.edu"
    [gov]="whois.nic.gov"
    [ac.uk]="whois.ja.net"
    [gov.uk]="whois.ja.net"
    [us]="whois.nic.us"
    [uk]="whois.nic.uk"
    [kr]="whois.nic.or.kr"
    [co.kr]="whois.nic.or.kr"
    [or.kr]="whois.nic.or.kr"
    [ne.kr]="whois.nic.or.kr"
    [pe.kr]="whois.nic.or.kr"
    [go.kr]="whois.nic.or.kr"
    [re.kr]="whois.nic.or.kr"
    [ac.kr]="whois.nic.or.kr"
    [hs.kr]="whois.nic.or.kr"
    [ms.kr]="whois.nic.or.kr"
    [es.kr]="whois.nic.or.kr"
    [sc.kr]="whois.nic.or.kr"
    [kg.kr]="whois.nic.or.kr"
    [mil.kr]="whois.nic.or.kr"
)

# Configuration: Query prefixes (= prefix for thick whois)
declare -A QUERY_PREFIXES=(
    [com]="="
    [net]="="
)

# Configuration: Rate limits (queries per day)
declare -A RATE_LIMITS=(
    [kr]=200
    [org]=200
)

# Helper function: Convert month names to numbers
convert_month_to_number() {
    echo "$1" | sed \
        -e "s/\-Jan\-/\-01\-/g" -e "s/\-Feb\-/\-02\-/g" -e "s/\-Mar\-/\-03\-/g" \
        -e "s/\-Apr\-/\-04\-/g" -e "s/\-May\-/\-05\-/g" -e "s/\-Jun\-/\-06\-/g" \
        -e "s/\-Jul\-/\-07\-/g" -e "s/\-Aug\-/\-08\-/g" -e "s/\-Sep\-/\-09\-/g" \
        -e "s/\-Oct\-/\-10\-/g" -e "s/\-Nov\-/\-11\-/g" -e "s/\-Dec\-/\-12\-/g"
}

for domain in ${domains[@]}; do

    # [1] Validate domain name format
    # Basic format: alphanumeric characters, hyphens, and dots
    # Must not start or end with hyphen, must have at least one dot
    if ! [[ "$domain" =~ ^[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?(\.[a-zA-Z0-9]([a-zA-Z0-9-]*[a-zA-Z0-9])?)+$ ]]; then
        echo "** ERROR: Invalid domain format: \"$domain\"" 1>&2
        continue
    fi

    # [2] Validate TLD is supported
    # Extract TLD (handle multi-level TLDs like .ac.uk, .gov.uk, .co.kr, etc.)
    tld="${domain##*.}"
    if [[ "$domain" =~ \.(ac|gov|co|or|ne|pe|go|re|hs|ms|es|sc|kg|mil)\.[^.]+$ ]]; then
        # Multi-level TLD
        second_level="${domain%.*}"
        second_level="${second_level##*.}"
        tld="$second_level.$tld"
    fi

    # Check if TLD is configured
    if [[ -z "${WHOIS_SERVERS[$tld]}" ]]; then
        echo "** ERROR: TLD \".$tld\" not supported for domain \"$domain\"" 1>&2
        echo "** Supported TLDs: ${!WHOIS_SERVERS[@]}" 1>&2
        continue
    fi

    # [3] whois lookup
    if [[ "$force_refresh" -ne 0 ]] || [[ ! -f "$cache_dir/$domain" ]]; then
        #
        # rate limiting (uses top-level domain only, e.g., "kr" not "co.kr")
        #
        rate_limit_tld="${domain##*.}"
        if [[ -n "${RATE_LIMITS[$rate_limit_tld]}" ]]; then
            limit="${RATE_LIMITS[$rate_limit_tld]}"
            count=$(find "$cache_dir/" -name "*.$rate_limit_tld" -ctime -1 2>/dev/null | wc -l)
            if [[ "$count" -gt "$limit" ]]; then
                echo "** $domain too many .$rate_limit_tld lookup! ($count/$limit per day)" 1>&2
                continue
            fi
        fi

        #
        # lookup (TLD already validated and extracted above)
        #
        # Lookup WHOIS server for this TLD
        whois_server="${WHOIS_SERVERS[$tld]}"

        # Get query prefix if any (e.g., "=" for .com/.net thick whois)
        query_prefix="${QUERY_PREFIXES[$tld]}"

        # Perform lookup
        if ! printf "${query_prefix}$domain\r\n" | nc "$whois_server" 43 > "$cache_dir/$domain"; then
            echo "** ERROR: Lookup failed for $domain (server: $whois_server)" 1>&2
            rm -f "$cache_dir/$domain"
            continue
        fi

        # Check if response is not empty
        if [[ ! -s "$cache_dir/$domain" ]]; then
            echo "** ERROR: Empty response for $domain (server: $whois_server)" 1>&2
            rm -f "$cache_dir/$domain"
            continue
        fi
    fi

    # registrar lookup
    # must be either .com or .net
    if [[ "$registrar" -ne 0 ]] && [[ -n "$(echo "$domain" | grep -o '\.\(com\|net\)$')" ]]; then
        #rwhois="$(grep "Registrar WHOIS Server:" "$cache_dir/$domain" | grep -o "[a-z0-9][a-z0-9\-\.]\+[a-z]$")"
        rwhois="$(grep "Registrar WHOIS Server:" "$cache_dir/$domain" \
            | sed -e 's/^[[:space:]]*Registrar WHOIS Server:[[:space:]]*//' -e 's/[[:space:]]*$//' \
            | tr -d '\r\n')"
        rcache_dir="$cache_dir/registrar-$rwhois-cache"
        rcache="$rcache_dir/$domain"
        if [[ "$force_refresh" -ne 0 ]] || [[ ! -f "$rcache" ]]; then
            if [[ -z "$rwhois" ]]; then
                echo "** WARNING: No registrar WHOIS server found for $domain" 1>&2
            else
                if [[ ! -d "$rcache_dir" ]]; then
                    mkdir -p "$rcache_dir"
                fi
                if ! printf "$domain\r\n" | nc "$rwhois" 43 > "$rcache"; then
                    echo "** WARNING: Recursive lookup failed for $domain (server: $rwhois)" 1>&2
                    rm -f "$rcache"
                elif [[ ! -s "$rcache" ]]; then
                    echo "** WARNING: Empty recursive response for $domain (server: $rwhois)" 1>&2
                    rm -f "$rcache"
                fi
            fi
        fi
    fi

    # [4] show from cache
    if [[ "$summary" -eq 1 ]]; then
        # Summary mode: show only registration and expiry dates
        reg=""
        exp=""
        case $domain in
        *.com|*.net)
            reg="$(grep 'Creation Date:' "$cache_dir/$domain" | sed 's/^Creation Date: //' | grep -o "[0-9]\+-[0-9]\+-[0-9]\+")"
            exp="$(grep 'Registry Expiry Date:' "$cache_dir/$domain" | sed 's/^Registry Expiry Date: //' | grep -o "[0-9]\+-[0-9]\+-[0-9]\+")"
            ;;
        *.org|*.biz|*.us|*.gov)
            reg="$(grep 'Creation Date:' "$cache_dir/$domain" | sed 's/^Creation Date: //' | grep -o "[0-9]\+-[0-9]\+-[0-9]\+" | head -1)"
            exp="$(grep 'Registry Expiry Date:' "$cache_dir/$domain" | sed 's/^Registry Expiry Date: //' | grep -o "[0-9]\+-[0-9]\+-[0-9]\+" | head -1)"
            ;;
        *.edu)
            reg="$(grep 'Domain record activated:' "$cache_dir/$domain" | sed 's/.*\([0-9]\{2\}\)-\([A-Z][a-z]\{2\}\)-\([0-9]\{4\}\).*/\3-\2-\1/')"
            reg="$(convert_month_to_number "$reg")"
            exp="$(grep 'Domain expires:' "$cache_dir/$domain" | sed 's/.*\([0-9]\{2\}\)-\([A-Z][a-z]\{2\}\)-\([0-9]\{4\}\).*/\3-\2-\1/')"
            exp="$(convert_month_to_number "$exp")"
            ;;
        *.ac.uk|*.gov.uk)
            reg="$(sed -n '/Entry created:/,//p' "$cache_dir/$domain" | sed -n '2p' | sed -e 's/^[[:space:]]\+//' -e 's/\([0-9]\)\(st\|nd\|rd\|th\)/\1/g')"
            reg="$(date -d "$reg" +"%Y-%m-%d")"
            exp="$(sed -n '/Renewal date:/,//p' "$cache_dir/$domain" | sed -n '2p' | sed -e 's/^[[:space:]]\+//' -e 's/\([0-9]\)\(st\|nd\|rd\|th\)/\1/g')"
            exp="$(date -d "$exp" +"%Y-%m-%d")"
            ;;
        *.uk)
            reg="$(grep 'Registered on:' "$cache_dir/$domain" | sed -e 's/.* before Aug-1996/before 08-1996/' \
                -e 's/.*\([0-9]\{2\}\)-\([A-Z][a-z]\{2\}\)-\([0-9]\{4\}\).*/\3-\2-\1/' \
                -e 's/[[:space:]]*$//')"
            reg="$(convert_month_to_number "$reg")"
            exp="$(grep 'Expiry date:' "$cache_dir/$domain" | sed \
                -e 's/.*\([0-9]\{2\}\)-\([A-Z][a-z]\{2\}\)-\([0-9]\{4\}\).*/\3-\2-\1/' \
                -e 's/[[:space:]]*$//')"
            exp="$(convert_month_to_number "$exp")"
            ;;
        *.kr|*.co.kr|*.or.kr|*.ne.kr|*.pe.kr|*.go.kr|*.re.kr|*.ac.kr|*.hs.kr|*.ms.kr|*.es.kr|*.sc.kr|*.kg.kr|*.mil.kr)
            reg="$(grep 'Registered Date' "$cache_dir/$domain" | sed 's/.*\([0-9]\{4\}\)\. \([0-9]\{2\}\)\. \([0-9]\{2\}\)\./\1-\2-\3/')"
            exp="$(grep 'Expiration Date' "$cache_dir/$domain" | sed 's/.*\([0-9]\{4\}\)\. \([0-9]\{2\}\)\. \([0-9]\{2\}\)\./\1-\2-\3/')"
            ;;
        *)
            reg="$(cat "$cache_dir/$domain")"
            ;;
        esac

        extlen=$(echo "$domain" | grep -o '\..\+$' | wc -c)
        spaces=""
        case $extlen in
        3)
            spaces="     "
            ;;
        4)
            spaces="    "
            ;;
        5)
            spaces="   "
            ;;
        6)
            spaces="  "
            ;;
        7)
            spaces=" "
            ;;
        *)
            spaces=""
            ;;
        esac

        if [[ -n "$reg" ]]; then
            echo "$domain$spaces $reg $exp"
        else
            echo "$domain$spaces *** available ***"
        fi
    else
        # Full output mode (default): show complete WHOIS data
        case $domain in
        *.com|*.net)
            cat "$cache_dir/$domain"
            #rwhois="$(grep "Registrar WHOIS Server:" "$cache_dir/$domain" | grep -o "[a-z0-9][a-z0-9\-\.]\+[a-z]$")"
            rwhois="$(grep "Registrar WHOIS Server:" "$cache_dir/$domain" \
                | sed -e 's/^[[:space:]]*Registrar WHOIS Server:[[:space:]]*//' -e 's/[[:space:]]*$//' \
                | tr -d '\r\n')"
            rcache_dir="$cache_dir/registrar-$rwhois-cache"
            rcache="$rcache_dir/$domain"
            if [[ -f "$rcache" ]]; then
                cat "$rcache"
            fi
            ;;
        *)
            cat "$cache_dir/$domain"
            ;;
        esac
    fi

done
