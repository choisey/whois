#!/bin/bash

if [[ $# -lt 1 ]]; then
    echo "Usage: $0 [options]? [domain-name]" 1>&2
    echo "Options:" 1>&2
    echo -e "\t--no-cache (-n)  Enforce a lookup bypassing cached data" 1>&2
    echo -e "\t--recursion (-r) Recursive query to registrar's whois server (.com and .net)" 1>&2
    echo -e "\t--view (-v)      View the lookup result" 1>&2
    exit
fi

nocache=0
recursion=0
view=0

domains=()
for d in $@; do
    case $d in
    "--no-cache"|"-n")
        nocache=1
        ;;
    "--recursion"|"-r")
        recursion=1
        ;;
    "--view"|"-v")
        view=1
        ;;
    *)
        domains+=($d)
        ;;
    esac
done

dir=$(dirname $0)
cache_dir="$dir/whois-cache"

if [[ ! -d $cache_dir ]]; then
    mkdir -p "$cache_dir"
fi

# Configuration: WHOIS servers by TLD
declare -A WHOIS_SERVERS=(
    [com]="whois.verisign-grs.com"
    [net]="whois.verisign-grs.com"
    [org]="whois.pir.org"
    [info]="whois.nic.info"
    [biz]="whois.biz"
    [mobi]="whois.dotmobiregistry.net"
    [edu]="whois.educause.edu"
    [gov]="whois.nic.gov"
    [ac.uk]="whois.ja.net"
    [gov.uk]="whois.ja.net"
    [us]="whois.nic.us"
    [uk]="whois.nic.uk"
    [kr]="whois.nic.or.kr"
)

# Configuration: Query prefixes (= prefix for thick whois)
declare -A QUERY_PREFIXES=(
    [com]="="
    [net]="="
)

# Configuration: Rate limits (queries per day)
declare -A RATE_LIMITS=(
    [kr]=200
    [org]=200
    [info]=200
)

# Helper function: Convert month names to numbers
convert_month_to_number() {
    echo "$1" | sed \
        -e "s/\-Jan\-/\-01\-/g" -e "s/\-Feb\-/\-02\-/g" -e "s/\-Mar\-/\-03\-/g" \
        -e "s/\-Apr\-/\-04\-/g" -e "s/\-May\-/\-05\-/g" -e "s/\-Jun\-/\-06\-/g" \
        -e "s/\-Jul\-/\-07\-/g" -e "s/\-Aug\-/\-08\-/g" -e "s/\-Sep\-/\-09\-/g" \
        -e "s/\-Oct\-/\-10\-/g" -e "s/\-Nov\-/\-11\-/g" -e "s/\-Dec\-/\-12\-/g"
}

for domain in ${domains[@]}; do

    # [1] is the domain name is valid?
    #if [[ "$(echo "$domain" | grep -e '^[a-z0-9]\([a-z0-9\-]*[a-z0-9]\)\?\.\(com\|net\|org\|info\|biz\|us\|co.uk\|co\.kr\|ne\.kr\|or\.kr\|kr\)$')" != "$domain" ]]; then
    #    echo "** ERROR: domain \"$domain\" not supported" 1>&2
    #    continue
    #fi

    # [2] whois lookup
    if [[ "$nocache" -ne 0 ]] || [[ ! -f "$cache_dir/$domain" ]]; then
        #
        # rate limiting
        #
        # Extract TLD from domain
        tld="${domain##*.}"

        # Check if this TLD has rate limiting
        if [[ -n "${RATE_LIMITS[$tld]}" ]]; then
            limit="${RATE_LIMITS[$tld]}"
            count=$(find "$cache_dir/" -name "*.$tld" -ctime -1 2>/dev/null | wc -l)
            if [[ "$count" -gt "$limit" ]]; then
                echo "** $domain too many .$tld lookup! ($count/$limit per day)" 1>&2
                continue
            fi
        fi

        #
        # lookup
        #
        # Extract TLD (handle multi-level TLDs like .ac.uk, .gov.uk)
        tld="${domain##*.}"
        if [[ "$domain" =~ \.(ac|gov|co)\.[^.]+$ ]]; then
            # Multi-level TLD (e.g., .ac.uk, .gov.uk, .co.uk)
            tld="${domain##*.}"
            second_level="${domain%.*}"
            second_level="${second_level##*.}"
            tld="$second_level.$tld"
        fi

        # Lookup WHOIS server for this TLD
        whois_server="${WHOIS_SERVERS[$tld]}"
        if [[ -z "$whois_server" ]]; then
            echo "** ERROR: domain \"$domain\" (TLD: .$tld) not supported" 1>&2
            exit 1
        fi

        # Get query prefix if any (e.g., "=" for .com/.net thick whois)
        query_prefix="${QUERY_PREFIXES[$tld]}"

        # Perform lookup
        if ! printf "${query_prefix}$domain\r\n" | nc "$whois_server" 43 > "$cache_dir/$domain"; then
            echo "** ERROR: Lookup failed for $domain (server: $whois_server)" 1>&2
            rm -f "$cache_dir/$domain"
            continue
        fi

        # Check if response is not empty
        if [[ ! -s "$cache_dir/$domain" ]]; then
            echo "** ERROR: Empty response for $domain (server: $whois_server)" 1>&2
            rm -f "$cache_dir/$domain"
            continue
        fi
    fi

    # recursion
    # must be either .com or .net
    if [[ "$recursion" -ne 0 ]] && [[ -n "$(echo "$domain" | grep -o '\.\(com\|net\)$')" ]]; then
        #rwhois="$(cat "$cache_dir/$domain" | grep "Registrar WHOIS Server:" | grep -o "[a-z0-9][a-z0-9\-\.]\+[a-z]$")"
        rwhois="$(cat "$cache_dir/$domain" \
            | grep "Registrar WHOIS Server:" \
            | sed -e 's/^[[:space:]]*Registrar\ WHOIS\ Server:[[:space:]]*//' -e 's/[\r\n]\+//' \
            | tr -d '\n')"
        rcache_dir="$cache_dir/registrar-$rwhois-cache"
        rcache="$rcache_dir/$domain"
        if [[ "$nocache" -ne 0 ]] || [[ ! -f "$rcache" ]]; then
            if [[ -z "$rwhois" ]]; then
                echo "** WARNING: No registrar WHOIS server found for $domain" 1>&2
            else
                if [[ ! -d "$rcache_dir" ]]; then
                    mkdir -p "$rcache_dir"
                fi
                if ! printf "$domain\r\n" | nc "$rwhois" 43 > "$rcache"; then
                    echo "** WARNING: Recursive lookup failed for $domain (server: $rwhois)" 1>&2
                    rm -f "$rcache"
                elif [[ ! -s "$rcache" ]]; then
                    echo "** WARNING: Empty recursive response for $domain (server: $rwhois)" 1>&2
                    rm -f "$rcache"
                fi
            fi
        fi
    fi

    # [3] show from cache
    if [[ "$view" -eq 0 ]]; then
        # show only the creation date
        reg=""
        exp=""
        case $domain in
        *.com|*.net)
            reg="$(cat "$cache_dir/$domain" | grep 'Creation Date:' | sed 's/^Creation\ Date:\ //' | grep -o "[0-9]\+-[0-9]\+-[0-9]\+")"
            exp="$(cat "$cache_dir/$domain" | grep 'Registry Expiry Date:' | sed 's/^Registry Expiry Date:\ //' | grep -o "[0-9]\+-[0-9]\+-[0-9]\+")"
            ;;
        *.org|*.info|*.biz|*.us|*.gov)
            reg="$(cat "$cache_dir/$domain" | grep 'Creation Date:' | sed 's/^Creation\ Date:\ //' | grep -o "[0-9]\+-[0-9]\+-[0-9]\+" | head -1)"
            exp="$(cat "$cache_dir/$domain" | grep 'Registry Expiry Date:' | sed 's/^Registry Expiry Date:\ //' | grep -o "[0-9]\+-[0-9]\+-[0-9]\+" | head -1)"
            ;;
        *.edu)
            reg="$(cat "$cache_dir/$domain" | grep 'Domain record activated:' | sed -e "s/^.\+\([0-9]\{2\}\)-\([A-Z][a-z]\{2\}\)-\([0-9]\{4\}\)/\3-\2-\1/")"
            reg="$(convert_month_to_number "$reg")"
            exp="$(cat "$cache_dir/$domain" | grep 'Domain expires:' | sed -e "s/^.\+\([0-9]\{2\}\)-\([A-Z][a-z]\{2\}\)-\([0-9]\{4\}\)/\3-\2-\1/")"
            exp="$(convert_month_to_number "$exp")"
            ;;
        *.ac.uk|*.gov.uk)
            reg="$(cat "$cache_dir/$domain" | sed -n '/Entry created:/,//p' | sed -n '2,2p' | sed -e 's/^[[:space:]]\+//' | sed 's/\([0-9]\+\)\(st\|nd\|rd\|th\)/\1/')"
            reg="$(date -d "$(echo "$reg" | sed 's/\([0-9]\+\)\(st\|nd\|rd\|th\)/\1/')" +"%Y-%m-%d")"
            exp="$(cat "$cache_dir/$domain" | sed -n '/Renewal date:/,//p' | sed -n '2,2p' | sed -e 's/^[[:space:]]\+//' | sed 's/\([0-9]\+\)\(st\|nd\|rd\|th\)/\1/')"
            exp="$(date -d "$(echo "$exp" | sed 's/\([0-9]\+\)\(st\|nd\|rd\|th\)/\1/')" +"%Y-%m-%d")"
            ;;
        *.uk)
            reg="$(cat "$cache_dir/$domain" | grep 'Registered on:' | sed -e "s/^.\+\ before Aug-1996/before 08-1996/" \
                -e "s/^.\+\([0-9]\{2\}\)-\([A-Z][a-z]\{2\}\)-\([0-9]\{4\}\)/\3-\2-\1/" \
                -e 's/[\r\n]\+$//')"
            reg="$(convert_month_to_number "$reg")"
            exp="$(cat "$cache_dir/$domain" | grep 'Expiry date:' | sed \
                -e "s/^.\+\([0-9]\{2\}\)-\([A-Z][a-z]\{2\}\)-\([0-9]\{4\}\)/\3-\2-\1/" \
                -e 's/[\r\n]\+$//')"
            exp="$(convert_month_to_number "$exp")"
            ;;
        *.kr)
            reg="$(cat "$cache_dir/$domain" | grep 'Registered Date' | sed "s/^.\+\([0-9]\{4\}\)\.\ \([0-9]\{2\}\)\.\ \([0-9]\{2\}\)\./\1-\2-\3/")"
            exp="$(cat "$cache_dir/$domain" | grep 'Expiration Date' | sed "s/^.\+\([0-9]\{4\}\)\.\ \([0-9]\{2\}\)\.\ \([0-9]\{2\}\)\./\1-\2-\3/")"
            ;;
        *)
            reg="$(cat "$cache_dir/$domain")"
            ;;
        esac

        extlen=$(echo "$domain" | grep -o '\..\+$' | wc -c)
        spaces=""
        case $extlen in
        3)
            spaces="     "
            ;;
        4)
            spaces="    "
            ;;
        5)
            spaces="   "
            ;;
        6)
            spaces="  "
            ;;
        7)
            spaces=" "
            ;;
        *)
            spaces=""
            ;;
        esac

        if [[ -n "$reg" ]]; then
            echo "$domain$spaces $reg $exp"
        else
            echo "$domain$spaces *** available ***"
        fi
    else
        case $domain in
        *.com|*.net)
            cat "$cache_dir/$domain"
            #rwhois="$(cat "$cache_dir/$domain" | grep "Registrar WHOIS Server:" | grep -o "[a-z0-9][a-z0-9\-\.]\+[a-z]$")"
            rwhois="$(cat "$cache_dir/$domain" \
                | grep "Registrar WHOIS Server:" \
                | sed -e 's/^[[:space:]]*Registrar\ WHOIS\ Server:[[:space:]]*//' -e 's/[\r\n]\+//' \
                | tr -d '\n')"
            rcache_dir="$cache_dir/registrar-$rwhois-cache"
            rcache="$rcache_dir/$domain"
            if [[ -f "$rcache" ]]; then
                cat "$rcache"
            fi
            ;;
        *)
            cat "$cache_dir/$domain"
            ;;
        esac
    fi

done
