#!/bin/bash

if [[ $# -lt 1 ]]; then
    echo "Usage: $0 [options]? [domain-name]" 1>&2
    echo "Options:" 1>&2
    echo -e "\t--no-cache (-n)  Enforce a lookup bypassing cached data" 1>&2
    echo -e "\t--recursion (-r) Recursive query to registrar's whois server (.com and .net)" 1>&2
    echo -e "\t--view (-v)      View the lookup result" 1>&2
    exit
fi

nocache=0
recursion=0
view=0

domains=()
for d in $@; do
    case $d in
    "--no-cache"|"-n")
        nocache=1
        ;;
    "--recursion"|"-r")
        recursion=1
        ;;
    "--view"|"-v")
        view=1
        ;;
    *)
        domains+=($d)
        ;;
    esac
done

dir=$(dirname $0)
cache_dir="$dir/whois-cache"

if [[ ! -d $cache_dir ]]; then
    mkdir -p "$cache_dir"
fi

for domain in ${domains[@]}; do

    # [1] is the domain name is valid?
    #if [[ "$(echo "$domain" | grep -e '^[a-z0-9]\([a-z0-9\-]*[a-z0-9]\)\?\.\(com\|net\|org\|info\|biz\|us\|co.uk\|co\.kr\|ne\.kr\|or\.kr\|kr\)$')" != "$domain" ]]; then
    #    echo "** ERROR: domain \"$domain\" not supported" 1>&2
    #    continue
    #fi

    # [2] whois lookup
    if [[ "$nocache" -ne 0 ]] || [[ ! -f "$cache_dir/$domain" ]]; then
        #
        # rate limiting
        #
        case $domain in
        *.kr)
            if [[ "$(find "$cache_dir/" -name *.kr -ctime -1 | wc -l)" -gt 200 ]]; then
                echo "** $domain too many .KR lookup!" 1>&2
                continue
            fi
            ;;
        *.org)
            if [[ "$(find "$cache_dir/" -name *.org -ctime -1 | wc -l)" -gt 200 ]]; then
                echo "** $domain too many .ORG lookup!" 1>&2
                continue
            fi
            ;;
        *.info)
            if [[ "$(find "$cache_dir/" -name *.org -ctime -1 | wc -l)" -gt 200 ]]; then
                echo "** $domain too many .INFO lookup!" 1>&2
                continue
            fi
            ;;
        esac

        #
        # lookup
        #
        case $domain in
        *.com|*.net)
            printf "=$domain\r\n" | nc whois.verisign-grs.com 43 > "$cache_dir/$domain"
            ;;
        *.org)
            printf "$domain\r\n" | nc whois.pir.org 43 > "$cache_dir/$domain"
            ;;
        *.info)
            printf "$domain\r\n" | nc whois.nic.info 43 > "$cache_dir/$domain" # whois.afilias.net ??
            ;;
        *.biz)
            printf "$domain\r\n" | nc whois.biz 43 > "$cache_dir/$domain"
            ;;
        *.mobi)
            printf "$domain\r\n" | nc whois.dotmobiregistry.net 43 > "$cache_dir/$domain"
            ;;
        *.edu)
            printf "$domain\r\n" | nc whois.educause.edu 43 > "$cache_dir/$domain"
            ;;
        *.gov)
            printf "$domain\r\n" | nc whois.nic.gov 43 > "$cache_dir/$domain"
            ;;
        *.kr)
            printf "$domain\r\n" | nc whois.nic.or.kr 43 > "$cache_dir/$domain"
            ;;
        *)
            #whois $domain > "$cache_dir/$domain"
            echo "** ERROR: domain \"$domain\" not supported" 1>&2
            exit 1
            ;;
        esac
    fi

    # recursion
    # must be either .com or .net
    if [[ "$recursion" -ne 0 ]] && [[ -n "$(echo "$domain" | grep -o '\.\(com\|net\)$')" ]]; then
        #rwhois="$(cat "$cache_dir/$domain" | grep "Registrar WHOIS Server:" | grep -o "[a-z0-9][a-z0-9\-\.]\+[a-z]$")"
        rwhois="$(cat "$cache_dir/$domain" \
            | grep "Registrar WHOIS Server:" \
            | sed -e 's/^[[:space:]]*Registrar\ WHOIS\ Server:[[:space:]]*//' -e 's/[\r\n]\+//' \
            | tr -d '\n')"
        rcache_dir="$cache_dir/registrar-$rwhois-cache"
        rcache="$rcache_dir/$domain"
        if [[ "$nocache" -ne 0 ]] || [[ ! -f "$rcache" ]]; then
            if [[ ! -d "$rcache_dir" ]]; then
                mkdir -p "$rcache_dir"
            fi
            printf "$domain\r\n" | nc "$rwhois" 43 > "$rcache"
        fi
    fi

    # [3] show from cache
    if [[ "$view" -eq 0 ]]; then
        # show only the creation date
        reg=""
        case $domain in
        *.com|*.net)
            reg="$(cat "$cache_dir/$domain" | grep 'Creation Date:' | sed 's/^Creation\ Date:\ //' | grep -o "[0-9]\+-[0-9]\+-[0-9]\+")"
            ;;
        *.org|*.info|*.biz|*.us|*.gov)
            reg="$(cat "$cache_dir/$domain" | grep 'Creation Date:' | sed 's/^Creation\ Date:\ //' | grep -o "[0-9]\+-[0-9]\+-[0-9]\+" | head -1)"
            ;;
        *.uk)
            reg="$(cat "$cache_dir/$domain" | grep 'Registered on:' | sed -e "s/^.\+\ before Aug-1996$/before 08-1996/" \
                -e "s/^.\+\([0-9]\{2\}\)-\([A-Z][a-z]\{2\}\)-\([0-9]\{4\}\)/\3-\2-\1/" \
                -e "s/\-Jan\-/\-01\-/" -e "s/\-Feb\-/\-02\-/" -e "s/\-Mar\-/\-03\-/" -e "s/\-Apr\-/\-04\-/" -e "s/\-May\-/\-05\-/" -e "s/\-Jun\-/\-06\-/" \
                -e "s/\-Jul\-/\-07\-/" -e "s/\-Aug\-/\-08\-/" -e "s/\-Sep\-/\-09\-/" -e "s/\-Oct\-/\-10\-/" -e "s/\-Nov\-/\-11\-/" -e "s/\-Dec\-/\-12\-/")"
            ;;
        *.edu)
            reg="$(cat "$cache_dir/$domain" | grep 'Domain expires:' | sed -e "s/^.\+\([0-9]\{2\}\)-\([A-Z][a-z]\{2\}\)-\([0-9]\{4\}\)/\3-\2-\1/" \
                -e "s/\-Jan\-/\-01\-/" -e "s/\-Feb\-/\-02\-/" -e "s/\-Mar\-/\-03\-/" -e "s/\-Apr\-/\-04\-/" -e "s/\-May\-/\-05\-/" -e "s/\-Jun\-/\-06\-/" \
                -e "s/\-Jul\-/\-07\-/" -e "s/\-Aug\-/\-08\-/" -e "s/\-Sep\-/\-09\-/" -e "s/\-Oct\-/\-10\-/" -e "s/\-Nov\-/\-11\-/" -e "s/\-Dec\-/\-12\-/")"
            ;;
        *.kr)
            reg="$(cat "$cache_dir/$domain" | grep 'Registered Date' | sed "s/^.\+\([0-9]\{4\}\)\.\ \([0-9]\{2\}\)\.\ \([0-9]\{2\}\)\./\1-\2-\3/")"
            ;;
        *)
            reg="$(cat "$cache_dir/$domain")"
            ;;
        esac

        extlen=$(echo "$domain" | grep -o '\..\+$' | wc -c)
        spaces=""
        case $extlen in
        3)
            spaces="     "
            ;;
        4)
            spaces="    "
            ;;
        5)
            spaces="   "
            ;;
        6)
            spaces="  "
            ;;
        7)
            spaces=" "
            ;;
        *)
            spaces=""
            ;;
        esac

        if [[ -n "$reg" ]]; then
            echo "$domain$spaces $reg"
        else
            echo "$domain$spaces *** available ***"
        fi
    else
        case $domain in
        *.com|*.net)
            cat "$cache_dir/$domain"
            #rwhois="$(cat "$cache_dir/$domain" | grep "Registrar WHOIS Server:" | grep -o "[a-z0-9][a-z0-9\-\.]\+[a-z]$")"
            rwhois="$(cat "$cache_dir/$domain" \
                | grep "Registrar WHOIS Server:" \
                | sed -e 's/^[[:space:]]*Registrar\ WHOIS\ Server:[[:space:]]*//' -e 's/[\r\n]\+//' \
                | tr -d '\n')"
            rcache_dir="$cache_dir/registrar-$rwhois-cache"
            rcache="$rcache_dir/$domain"
            if [[ -f "$rcache" ]]; then
                cat "$rcache"
            fi
            ;;
        *)
            cat "$cache_dir/$domain"
            ;;
        esac
    fi

done
